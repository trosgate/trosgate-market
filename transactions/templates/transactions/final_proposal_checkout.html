{% extends "dashboard/main_base.html" %}
{% load static %}
{% block content%}

        <div class="wt-dashboardbox">
            <div class="wt-proposalsr">
                <div class="container"><br><br><br>
                    <div class="wt-managejobcontent">
                        <div class="col-12">
                            <h3>
                                {% if gateway_type.name == "PayPal" %}
                                PayPal
                                {% elif gateway_type.name == "Flutterwave" %} 
                                Flutterwave
                                {% elif gateway_type.name == "Stripe" %}
                                Stripe
                                {% elif gateway_type.name == "Razorpay" %} 
                                Razorpay
                                {% endif %} 
                                Checkout
                            </h3>
                        </div>
                        <div class="col-12">
                            <div class="wt-updatall">
								<span>
                                    {% if hiring_box.get_total_price_before_fee >= 500 %} 
                                    You just won yourself a 10% ({{base_currency}}{{hiring_box.get_discount_value}}) discount on your total amount 
                                    {% else %}
                                    You could have saved 10% discount for every hire above $500 
                                    {% endif %}
                                </span>
							</div>	
                        </div>
                    </div>
                    
                    <div class="container">
                        <div class="row g-3">
                                
                            {% comment %} </div> {% endcomment %}
                            <div class="col-md-4 col-lg-4 order-md-last p-0 order-3">
                                <div class="row">
                                    <form method="POST">
                                        {{ currency}}
                                        <br>
                                        <div class="p-2 bd-highlight">
                                            <span id="feedback-converter" style="color:green; text-align:right;">.</span>
                                        </div>
                                        <button type="button" id="convert-currency" role="status" class="btn btn-primary w-100 fw-bold spinner-border">Convert</button>                            
                                    </form>
                                </div>
                                <div class="d-flex bd-highlight ms-0">
                                    <div class="p-2 flex-grow-1 bd-highlight">Total Salary:</div>
                                    <div class="p-2 bd-highlight"><span class="fw-bold h5">{{base_currency}}</span><span id="grandttotal"
                                    class="fw-bold h5">{{hiring_box.get_total_price_before_fee_and_discount}}</span></div>
                                </div>
                                <div class="d-flex bd-highlight">
                                    <div class="p-2 flex-grow-1 bd-highlight">Processing Fees:</div>
                                    <div class="p-2 bd-highlight"><span class="fw-bold h5">{{base_currency}}</span><span id="totalFees"
                                    class="fw-bold h5">{{hiring_box.get_fee_payable}}</span></div>
                                </div>
                                <div class="d-flex bd-highlight">
                                    <div class="p-2 flex-grow-1 bd-highlight">Total Payable:</div>
                                    <div class="p-2 bd-highlight"><span class="fw-bold h5">{{base_currency}}</span><span id="totalSalary" 
                                        class="fw-bold h5">{{hiring_box.get_total_price_after_discount_and_fee}}</span></div>
                                    </div>
                                </div>
                                <div class="col-md-7 col-lg-8">
                                {% if gateway_type.name == "PayPal" %}
                                <!-- Paypal Div button starts -->
                                <div id="paypal-button-container"></div>
                                <!-- Paypal Div button ends -->

                                {% elif gateway_type.name == "Flutterwave" %}
                                <!-- Flutterwave section button starts -->
                                <div class="container">
                                    <div class="row">
                                    {% comment %} <form method="POST"> 
                                        <button type="button" id="flutterwave-payment" class="btn btn-primary w-100 fw-bold">Pay Now</button> 
                                        
                                    </form> {% endcomment %}
                                    <br class="my-5">
                                    <button onclick='flutterwavePay(event)' class="btn btn-primary w-100 fw-bold" >
                                    Pay with flutterwave
                                    </button>
                                    </div>
                                    </div>
                                </div>
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Flutterwave section button ends -->
                <!-- Stripe section button starts -->
                {% elif gateway_type.name == "Stripe" %}
                    <div class="container">
                        <div class="row">
                        <div id="stripepayment-form" class="col-12 col-lg-6 mx-auto">
                            <!-- Error messages in this element -->
                            <div id="stripecard-errors" class="a" role="alert">.</div>
                           
                            <div class="row g-4">
                                <div class="col-12">
                                <label for="stripepCustomer" class="form-label">Customer Name</label>
                                <input name="stripepCustomer" type="text" class="form-control" id="stripepCustomer" value="{{request.user.get_full_name}}" > readonly
                                <div class="invalid-feedback">
                                    Valid first name is required.
                                </div>
                                </div>
                                <div class="col-12">
                                <label for="stripepEmail" class="form-label">Email <span class="text-muted"></span></label>
                                <input name="stripepEmail" type="email" class="form-control" id="stripepEmail" value="{{request.user.email}}" readonly>
                                <div class="invalid-feedback">
                                    Please enter a valid email address for shipping updates.
                                </div>
                                </div>
                                <div class="col-12">
                                    <label for="stripepCountry" class="form-label">Country</label>
                                    <input name="stripepCountry" type="text" class="form-control" id="stripepCountry" value="{{request.user.country}}" readonly>
                                    <div class="invalid-feedback">
                                        Country field required.
                                    </div>
                                </div>
                                
                            </div>
                            <br class="my-5">
                            <button 
                            onclick='stripePay(event)' 
                            id="stripesubmit" class="btn btn-primary w-100 fw-bold" >
                            Pay with Stripe
                            </button>
                           
                        </div>
                        </div>
                    </div>
                    </div>
                </div>
                {% elif gateway_type.name == "Razorpay" %}
                    <button id="rzp-button1" class="btn btn-primary w-100 fw-bold">Pay with Razorpay</button>
                {% endif %}                 
                </div>
            </div>
         </div>
        <div class="wt-proposalholder mt-6">
            <div class="row justify-content-md-center">
                <div class="wt-sectionhead wt-textcenter">
                    <span>Copyright @ {{website.site_name}}</span>
                </div>
            </div>
        </div> 

    {% endblock content %}

    {% block scripts %}
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        //Script to add proposal quantity in session             
        $(document).on('click', '#convert-currency', function (e) {
        e.preventDefault();
        $.ajax({
            type: 'POST',
            url: '{% url "general_settings:converter" %}',
            data: {
                currencyid: $('#id_currency option:selected').val(),
                targetamount: '{{hiring_box.get_total_price_after_discount_and_fee}}',
                csrfmiddlewaretoken: "{{csrf_token}}",
                action: 'currency'
            },
            success: function (json) {
                document.getElementById('feedback-converter').innerHTML = json.message
            },
            error: function (xhr, errmsg, err) {}
        });
        })
    </script>

    {% if gateway_type.name == "PayPal" %}
    <script 
        src="https://www.paypal.com/sdk/js?client-id={{paypal_public_key}}&currency={{base_currency}}"data-sdk-integration-source="button-factory">
    </script>
    {% comment %} <script src="{% static 'js/payments/paypal-checkout.js' %}"></script>   {% endcomment %}
    <script>
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        let csrftoken = getCookie('csrftoken');
        
        function hiringPayPalButton() {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'gold',
                    shape: 'pill',
                    label: 'paypal',
                },
                createOrder: function (data, actions) {
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: '{{hiring_box.get_total_price_after_discount_and_fee}}'
                            }
                        }]
                    });
                },
                onApprove: function (data) {
                    let url = "{% url 'transactions:paypal_payment_order' %}"
                    return fetch(url, {
                        method: 'POST',
                        headers: {
                            'content-type': 'application/json',
                            'X-CSRFToken': csrftoken,
                        },
                        body: JSON.stringify({
                            orderID: data.orderID
                        })
                    }).then(function () {
                        swal("Perfect!", 'All looked good', "success").then((value) =>{
                            window.location.href = "{% url 'transactions:hiring_payment_success' %}"
                        });              
                        
                    })
                },
            }).render('#paypal-button-container');
        }
        hiringPayPalButton();
    </script>

    {% elif gateway_type.name == "Stripe" %}
    <script>
        var CSRF_TOKEN = '{{ csrf_token }}';
    </script>    
    <script src="https://js.stripe.com/v3/"></script>
    {% comment %} <script src="{% static 'js/payments/proposal-stripe-checkout.js' %}" data-rel-js></script> {% endcomment %}
    <script>
    function stripePay(event) {
        event.preventDefault();
      
        let stripepCustomer = document.getElementById("stripepCustomer").value;
        let stripepEmail = document.getElementById("stripepEmail").value;
        let stripepCountry = document.getElementById("stripepCountry").value;
      
        let displayError = document.getElementById('stripecard-errors')
      
        if (stripepCustomer == '' || stripepEmail == '' || stripepCountry == '') {
          displayError.textContent = 'Ooops! All fields are required';
          $('#stripecard-errors').addClass('alert alert-danger');
      
          return false
        }
        else {
          displayError.textContent = '';
          $('#stripecard-errors').removeClass('alert alert-danger');
          
      
          let data = {
            'stripepCustomer': stripepCustomer, 
            'stripepEmail': stripepEmail,
            'stripepCountry': stripepCountry,
      
          }
      
          let stripe = Stripe('{{stripe_public_key}}');
      
          fetch('/transaction/stripe/checkout/api/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{csrf_token}}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
            .then(function (response) {
              return response.json()
            })
            .then(function (session) {
              return stripe.redirectToCheckout({ sessionId: session.session.id })
            })
            .then(function (result) {
              return console.log(result.error.message)
            })
            .catch(function (error) {
              return console.log(error)
            })
        }
      }
    </script>
      
    {% elif gateway_type.name == "Flutterwave" %}
    <script src="https://checkout.flutterwave.com/v3.js"></script>
    {% comment %} <script src="{% static 'js/payments/flutterwave-checkout.js' %}"></script> {% endcomment %}
    <script>
        function flutterwavePay(event) {
        event.preventDefault();
      
          let data = {
            'amount': "{{hiring_box.get_total_price_after_discount_and_fee}}",
            'name': "{{request.user.get_full_name}}",
            'email': "{{request.user.email}}",
            'consumerid': "{{request.user.id}}",
      
          }
      
          fetch('{% url "transaction:flutter_payment_intent" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{csrf_token}}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
          })
            .then(function (response) {
              return response.json()
            })
            .then(function (session) {
                window.location.href = session.redirectToCheckout
            })
            .then(function (result) {
              return console.log(result)
            })
            .catch(function (error) {
              return console.log(error)
            })
        }

    </script> 
    {% elif gateway_type.name == "Razorpay" %}
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <script>
        //Script to add proposal quantity in session             
        $(document).on('click', '#rzp-button1', function (e) {
        e.preventDefault();
        $.ajax({
            method: 'GET',
            url: '{% url "transactions:razorpay_application_intent" %}',
            success: function (response) {
                console.log(response)
                var options = {
                    "key": "{{razorpay_public_key}}", // Enter the Key ID generated from the Dashboard
                    "amount": response.amount,//"{{hiring_box.get_total_price_after_discount_and_fee}}", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                    "currency": response.currency,
                    "name": "{{website.site_name}}",
                    "description": "Hiring of Applicants",
                    "image": "{{website.site_Logo.url}}",
                    "order_id": response.razorpay_order_key, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                    "handler": function (responseOne) {
                        $.ajax({
                            type: "POST",
                            url: "/transaction/razorpay_webhook/",
                            data: {
                                orderid: responseOne.razorpay_order_id,
                                paymentid: responseOne.razorpay_payment_id,
                                signature: responseOne.razorpay_signature,
                                csrfmiddlewaretoken: "{{csrf_token}}",
                                action: "razorpay-proposal",
                            },
                            success: function (responseTwo) {
                                console.log(responseTwo)
                                swal("Perfect!", 'All looked good', "success").then((value) =>{
                                    window.location.href = '/transaction/congrats/'
                                });                        
                            }
                        });
                    },

                    "prefill": {
                        "name": "{{request.user.get_full_name}}",
                        "email": "{{request.user.email}}",
                        "contact": "{{request.user.phone}}"
                    },
                    "notes": {
                        "address": "{{request.user.country}}"
                    },
                    "theme": {
                        "color": "#3399cc"
                    }
                };
                var rzp1 = new Razorpay(options);
                rzp1.open();                
            },
            error: function (xhr, errmsg, err) {}
        });
        })
    </script>

    {% endif %}
    {% endblock scripts %}
  
